{% extends 'base.html' %}
{% load custom_filters %} {# Keep this load tag #}

{% block title %}Coach Dashboard{% endblock %}

{% block content %}
    <h1>Coach Dashboard ({{ role }})</h1>
    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <p>Logged in as: <strong>{{ user.username }}</strong></p>
    <p>Your Groups:
        {% for group in user.groups.all %}
            <strong>{{ group.name }}</strong>{% if not forloop.last %}, {% endif %}
        {% empty %}
            None
	{% endfor %}
    </p>

    {% if is_project_manager %}
        <p><a href="{% url 'test_requests:create_tvf' %}" class="btn btn-primary">Create New TVF</a></p>
    {% endif %}

    {# NPI Specific Sections #}
    {% if is_npi_user or is_coach or user.is_superuser %}
        <hr>
        <h2>NPI Workflow Stages</h2>

        {# NPI Section 1: TVFs Released (Waiting for NPI Data Processing) #}
        <h3>TVFs Released (Waiting for NPI Data Processing)</h3>
        {% if npi_released_tvfs %}
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered">
                    <thead>
                        <tr>
                            <th>TVF Number</th>
                            <th>Name</th>
                            <th>Customer</th>
                            <th>Project</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tvf in npi_released_tvfs %}
                            <tr>
                                <td>{{ tvf.tvf_number }}</td>
                                <td>{{ tvf.tvf_name }}</td>
                                <td>{{ tvf.customer.name }}</td>
                                <td>{{ tvf.project.name }}</td>
                                <td>
                                    <form method="post" action="{% url 'test_requests:npi_update_tvf' tvf.pk %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" name="action" value="dp_done" class="btn btn-primary btn-sm">DP Done</button>
                                    </form>
                                    <form method="post" action="{% url 'test_requests:reject_tvf' tvf.pk %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" name="action" value="reject" class="btn btn-danger btn-sm">Reject</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p>No TVFs waiting for NPI Data Processing.</p>
        {% endif %}

        {# NPI Section 2: TVFs in DP Done State #}
        <h3 class="mt-4">TVFs in DP Done State</h3>
        {% if npi_dp_done_tvfs %}
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered">
                    <thead>
                        <tr>
                            <th>TVF Number</th>
                            <th>Name</th>
                            <th>Customer</th>
                            <th>Project</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tvf in npi_dp_done_tvfs %}
                            <tr>
                                <td>{{ tvf.tvf_number }}</td>
                                <td>{{ tvf.tvf_name }}</td>
                                <td>{{ tvf.customer.name }}</td>
                                <td>{{ tvf.project.name }}</td>
                                <td>
                                    <form method="post" action="{% url 'test_requests:npi_update_tvf' tvf.pk %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" name="action" value="tvf_output" class="btn btn-success btn-sm">TVF Output</button>
                                        <button type="submit" name="action" value="back_to_released" class="btn btn-secondary btn-sm">Back to Released</button> {# Added back button #}
                                    </form>
                                    <form method="post" action="{% url 'test_requests:reject_tvf' tvf.pk %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" name="action" value="reject" class="btn btn-danger btn-sm">Reject</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p>No TVFs currently in DP Done state.</p>
        {% endif %}

        {# NPI Section 3: TVFs Processed at NPI (Ready for QA Push) #}
        <h3 class="mt-4">TVFs Processed at NPI (Ready for Quality Push)</h3>
        {% if npi_processed_tvfs %}
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered">
                    <thead>
                        <tr>
                            <th>TVF Number</th>
                            <th>Name</th>
                            <th>Customer</th>
                            <th>Project</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tvf in npi_processed_tvfs %}
                            <tr>
                                <td>{{ tvf.tvf_number }}</td>
                                <td>{{ tvf.tvf_name }}</td>
                                <td>{{ tvf.customer.name }}</td>
                                <td>{{ tvf.project.name }}</td>
                                <td>
                                    <form method="post" action="{% url 'test_requests:npi_update_tvf' tvf.pk %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" name="action" value="push_to_qa" class="btn btn-primary btn-sm">Push to QA</button>
                                        <button type="submit" name="action" value="back_to_dp_done" class="btn btn-secondary btn-sm">Back to DP Done</button>
                                    </form>
                                    <form method="post" action="{% url 'test_requests:reject_tvf' tvf.pk %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" name="action" value="reject" class="btn btn-danger btn-sm">Reject</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p>No TVFs currently processed at NPI.</p>
        {% endif %}
    {% endif %}

    <hr class="mt-5">
    <h2>All Other Open TVFs</h2>
    {% if other_open_tvfs %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>TVF Number</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Current Status</th>
                        <th>Current Phase</th>
                        <th>Comments</th>
                        <th>Creation Date</th>
                        <th>Ship Date</th>
                        <th>Run Today?</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tvf in other_open_tvfs %}
                        <tr>
                            <td>{{ tvf.tvf_number }}</td>
                            <td>{{ tvf.tvf_name|default:"N/A" }}</td>
                            <td>{{ tvf.tvf_type.name|default:"N/A" }}</td>
                            <td>{{ tvf.status.name|default:"N/A" }}</td>
                            <td>{{ tvf.current_phase.name|default:"N/A" }}</td>
                            <td>{{ tvf.comments|truncatechars:50|default:"-" }}</td>
                            <td>{{ tvf.request_received_date|date:"Y-m-d H:i" }}</td>
                            <td>{{ tvf.request_ship_date|date:"Y-m-d"|default:"N/A" }}</td>
                            <td>
                                {% if tvf.run_today %}Yes{% else %}No{% endif %}
                            </td>
                            <td>
                                {# These buttons will only appear if the TVF is NOT in one of the specific NPI/Quality/Logistics sections #}
                                {% if is_npi_user and tvf.current_phase.name in npi_phases_for_button %}
                                    <a href="{% url 'test_requests:npi_update_tvf' tvf.pk %}" class="btn btn-info btn-sm">Update (NPI)</a> |
                                {% elif is_quality_user and tvf.current_phase.name in quality_phases_for_button %}
                                    <a href="{% url 'test_requests:quality_update_tvf' tvf.pk %}" class="btn btn-info btn-sm">Update (Quality)</a> |
                                {% elif is_logistics_user and tvf.current_phase.name in logistics_phases_for_button %}
                                    <a href="{% url 'test_requests:logistics_update_tvf' tvf.pk %}" class="btn btn-info btn-sm">Update (Logistics)</a> |
                                {% else %}
                                    <em>Not in your queue</em> |
                                {% endif %}

                                {% if tvf.status.name != 'Completed' and tvf.status.name != 'Shipped' %}
                                    {% if is_project_manager or is_npi_user or is_quality_user or is_logistics_user or is_coach %}
                                        <a href="{% url 'test_requests:reject_tvf' tvf.pk %}" class="btn btn-danger btn-sm">Reject</a>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>No other open TVFs found.</p>
    {% endif %}
{% endblock %}

{% block extra_js %}
{% load static %}
<script>
    // No specific JS needed here for the filtering or buttons as they are handled by Django templates and forms.
</script>
{% endblock %}