{% extends 'base.html' %}
{% load static %}
{% load custom_filters %} {# For accessing pans_formsets by index #}

{% block title %}Create New TVF{% endblock %}

{% block head %}
    {{ block.super }} {# Includes base.html's head content if any #}
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles (can be moved to a separate CSS file) */
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-weight: 600; margin-bottom: 0.25rem; color: #4a5568; }
        .form-control, select.form-control {
            display: block; width: 100%; padding: 0.5rem 0.75rem; font-size: 0.875rem; line-height: 1.5;
            color: #4a5568; background-color: #fff; border: 1px solid #e2e8f0; border-radius: 0.25rem;
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
        }
        .form-control:focus { border-color: #667eea; outline: 0; box-shadow: 0 0 0 0.2rem rgba(102,126,234,.25); }
        .form-check-input { width: 1rem; height: 1rem; margin-right: 0.5rem; vertical-align: middle; }
        .helptext { font-size: 0.75rem; color: #718096; margin-top: 0.25rem; }
        .errorlist { color: #e53e3e; font-size: 0.75rem; margin-top: 0.25rem; list-style: none; padding: 0; }
        .errorlist li { margin-bottom: 0.25rem; }

        .formset-row-container { padding: 1rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; margin-bottom: 1rem; background-color: #f9fafb; }
        .nested-formset-container { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #d1d5db; }
        
        .delete-button {
            background-color: #ef4444; color: white; padding: 0.375rem 0.75rem;
            border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;
            border: none; transition: background-color 0.2s;
        }
        .delete-button:hover { background-color: #dc2626; }
        .add-row-button {
            background-color: #22c55e; color: white; padding: 0.5rem 1rem;
            border-radius: 0.25rem; cursor: pointer; font-size: 0.875rem;
            border: none; transition: background-color 0.2s; margin-top: 0.5rem;
        }
        .add-row-button:hover { background-color: #16a34a; }
        /* Hide Django's default DELETE checkbox */
        input[type="checkbox"][name$="-DELETE"] { display: none; }
    </style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Create New TVF 
        {% if role %}<span class="text-indigo-600 text-xl">({{ role }})</span>{% endif %}
    </h1>

    {% if messages %}
    <div class="mb-4">
        {% for message in messages %}
        <div class="p-3 rounded-md 
            {% if message.tags == 'success' %}bg-green-100 text-green-700 border border-green-200
            {% elif message.tags == 'error' %}bg-red-100 text-red-700 border border-red-200
            {% else %}bg-blue-100 text-blue-700 border border-blue-200{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <form method="post" class="bg-white p-6 md:p-8 rounded-lg shadow-lg space-y-6">
        {% csrf_token %}

        {# ---- Main TestRequest Form Fields ---- #}
        <fieldset class="border border-gray-300 p-4 rounded-md">
            <legend class="text-xl font-semibold text-gray-700 px-2">General Information</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-2">
                {# Render fields from the main form 'form' #}
                {% for field in form %}
                    {% if field.name != 'tvf_initiator' %} {# Handled separately or not shown if auto #}
                    <div class="form-group">
                        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}:</label>
                        {{ field }}
                        {% if field.help_text %}<p class="helptext">{{ field.help_text }}</p>{% endif %}
                        {% for error in field.errors %}<div class="errorlist"><li>{{ error }}</li></div>{% endfor %}
                    </div>
                    {% endif %}
                {% endfor %}
<<<<<<< HEAD
                 <div class="form-group">
=======
            </div>
        {% endif %}

        <form method="post" class="bg-white p-8 rounded-lg shadow-md space-y-6">
            {% csrf_token %}

            {# Main TestRequest Form Fields #}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {# TVF Number (Auto-populated, Read-only) #}
                <div class="form-group">
                    <label class="form-label">TVF Number:</label>
                    <input type="text" class="form-control bg-gray-100 cursor-not-allowed" value="Auto-generated" disabled>
                    <p class="helptext">Will be auto-generated upon submission.</p>
                </div>

                {# CR Number #}
                <div class="form-group">
                    <label for="{{ form.cr_number.id_for_label }}" class="form-label">{{ form.cr_number.label }}:</label>
                    {{ form.cr_number }}
                    {% if form.cr_number.help_text %}<p class="helptext">{{ form.cr_number.help_text }}</p>{% endif %}
                    {% if form.cr_number.errors %}<ul class="errorlist">{{ form.cr_number.errors }}</ul>{% endif %}
                </div>
                
                {# TVF Name #}
                <div class="form-group">
                    <label for="{{ form.tvf_name.id_for_label }}" class="form-label">{{ form.tvf_name.label }}:</label>
                    {{ form.tvf_name }}
                    {% if form.tvf_name.help_text %}<p class="helptext">{{ form.tvf_name.help_text }}</p>{% endif %}
                    {% if form.tvf_name.errors %}<ul class="errorlist">{{ form.tvf_name.errors }}</ul>{% endif %}
                </div>

                {# Customer #}
                <div class="form-group">
                    <label for="{{ form.customer.id_for_label }}" class="form-label">{{ form.customer.label }}:</label>
                    {{ form.customer }}
                    {% if form.customer.help_text %}<p class="helptext">{{ form.customer.help_text }}</p>{% endif %}
                    {% if form.customer.errors %}<ul class="errorlist">{{ form.customer.errors }}</ul>{% endif %}
                </div>

                {# TVF Environment #}
                <div class="form-group">
                    <label for="{{ form.tvf_environment.id_for_label }}" class="form-label">{{ form.tvf_environment.label }}:</label>
                    {{ form.tvf_environment }}
                    {% if form.tvf_environment.help_text %}<p class="helptext">{{ form.tvf_environment.help_text }}</p>{% endif %}
                    {% if form.tvf_environment.errors %}<ul class="errorlist">{{ form.tvf_environment.errors }}</ul>{% endif %}
                </div>

                {# Project Name (Dynamic based on Customer and Environment) #}
                <div class="form-group">
                    <label for="{{ form.project.id_for_label }}" class="form-label">{{ form.project.label }}:</label>
                    {{ form.project }}
                    {% if form.project.help_text %}<p class="helptext">{{ form.project.help_text }}</p>{% endif %}
                    {% if form.project.errors %}<ul class="errorlist">{{ form.project.errors }}</ul>{% endif %}
                </div>

                {# TVF Initiator (Pre-filled with current user, not editable) #}
                <div class="form-group">
>>>>>>> parent of 63fccc0 (sdsd)
                    <label class="form-label">TVF Initiator:</label>
                    <input type="text" class="form-control bg-gray-100" value="{{ request.user.get_full_name|default:request.user.username }}" disabled>
                </div>
            </div>
            {% if form.non_field_errors %}
                <div class="errorlist mt-2">
                {% for error in form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
                </div>
            {% endif %}
        </fieldset>

<<<<<<< HEAD
        {# ---- Plastic Codes Section (Formset) ---- #}
        <fieldset class="border border-gray-300 p-4 rounded-md">
            <legend class="text-xl font-semibold text-gray-700 px-2">Plastic Codes</legend>
            <div id="plastic-code-formset-container" class="mt-2 space-y-4">
                {{ plastic_formset.management_form }}
                {% for pc_form in plastic_formset %}
                <div class="formset-row-container plastic-code-row" id="{{ plastic_formset.prefix }}-{{ forloop.counter0 }}">
                    {% for hidden in pc_form.hidden_fields %}{{ hidden }}{% endfor %}
                    {{ pc_form.DELETE }} {# Hidden DELETE checkbox #}
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div class="form-group md:col-span-2">
                            <label for="{{ pc_form.plastic_code_lookup.id_for_label }}" class="form-label">{{ pc_form.plastic_code_lookup.label }}</label>
                            {{ pc_form.plastic_code_lookup }}
                            {% for error in pc_form.plastic_code_lookup.errors %}<div class="errorlist"><li>{{ error }}</li></div>{% endfor %}
                        </div>
                        <div class="form-group">
                            <label for="{{ pc_form.manual_plastic_code.id_for_label }}" class="form-label">{{ pc_form.manual_plastic_code.label }}</label>
                            {{ pc_form.manual_plastic_code }}
                            {% if pc_form.manual_plastic_code.help_text %}<p class="helptext">{{ pc_form.manual_plastic_code.help_text }}</p>{% endif %}
                            {% for error in pc_form.manual_plastic_code.errors %}<div class="errorlist"><li>{{ error }}</li></div>{% endfor %}
                        </div>
                        <div class="form-group">
                            <label for="{{ pc_form.quantity.id_for_label }}" class="form-label">{{ pc_form.quantity.label }}</label>
                            {{ pc_form.quantity }}
                            {% for error in pc_form.quantity.errors %}<div class="errorlist"><li>{{ error }}</li></div>{% endfor %}
                        </div>
=======
                {# Request Ship Date (Calculated based on SLA) #}
                <div class="form-group">
                    <label for="{{ form.request_ship_date.id_for_label }}" class="form-label">{{ form.request_ship_date.label }}:</label>
                    {{ form.request_ship_date }}
                    {% if form.request_ship_date.help_text %}<p class="helptext">{{ form.request_ship_date.help_text }}</p>{% endif %}
                    {% if form.request_ship_date.errors %}<ul class="errorlist">{{ form.request_ship_date.errors }}</ul>{% endif %}
                </div>
            </div>

            <h2 class="text-2xl font-semibold text-gray-700 mt-8 mb-4">Codes & Comments</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {# S-Code #}
                <div class="form-group">
                    <label for="{{ form.s_code.id_for_label }}" class="form-label">{{ form.s_code.label }}:</label>
                    {{ form.s_code }}
                    {% if form.s_code.help_text %}<p class="helptext">{{ form.s_code.help_text }}</p>{% endif %}
                    {% if form.s_code.errors %}<ul class="errorlist">{{ form.s_code.errors }}</ul>{% endif %}
                </div>

                {# D-Code #}
                <div class="form-group">
                    <label for="{{ form.d_code.id_for_label }}" class="form-label">{{ form.d_code.label }}:</label>
                    {{ form.d_code }}
                    {% if form.d_code.help_text %}<p class="helptext">{{ form.d_code.help_text }}</p>{% endif %}
                    {% if form.d_code.errors %}<ul class="errorlist">{{ form.d_code.errors }}</ul>{% endif %}
                </div>

                {# Comments #}
                <div class="form-group md:col-span-2">
                    <label for="{{ form.comments.id_for_label }}" class="form-label">{{ form.comments.label }}:</label>
                    {{ form.comments }}
                    {% if form.comments.help_text %}<p class="helptext">{{ form.comments.help_text }}</p>{% endif %}
                    {% if form.comments.errors %}<ul class="errorlist">{{ form.comments.errors }}</ul>{% endif %}
                </div>
            </div>

            <h2 class="text-2xl font-semibold text-gray-700 mt-8 mb-4">Configuration Versions</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {# Trustport Folder (Dynamic based on Customer/Project) #}
                <div class="form-group">
                    <label for="{{ form.trustport_folder_actual.id_for_label }}" class="form-label">{{ form.trustport_folder_actual.label }}:</label>
                    {{ form.trustport_folder_actual }}
                    {% if form.trustport_folder_actual.help_text %}<p class="helptext">{{ form.trustport_folder_actual.help_text }}</p>{% endif %}
                    {% if form.trustport_folder_actual.errors %}<ul class="errorlist">{{ form.trustport_folder_actual.errors }}</ul>{% endif %}
                </div>

                {# Pres Config Version #}
                <div class="form-group">
                    <label for="{{ form.pres_config_version.id_for_label }}" class="form-label">{{ form.pres_config_version.label }}:</label>
                    {{ form.pres_config_version }}
                    {% if form.pres_config_version.help_text %}<p class="helptext">{{ form.pres_config_version.help_text }}</p>{% endif %}
                    {% if form.pres_config_version.errors %}<ul class="errorlist">{{ form.pres_config_version.errors }}</ul>{% endif %}
                </div>

                {# Proc Config Version #}
                <div class="form-group">
                    <label for="{{ form.proc_config_version.id_for_label }}" class="form-label">{{ form.proc_config_version.label }}:</label>
                    {{ form.proc_config_version }}
                    {% if form.proc_config_version.help_text %}<p class="helptext">{{ form.proc_config_version.help_text }}</p>{% endif %}
                    {% if form.proc_config_version.errors %}<ul class="errorlist">{{ form.proc_config_version.errors }}</ul>{% endif %}
                </div>

                {# PIN Config Version #}
                <div class="form-group">
                    <label for="{{ form.pin_config_version.id_for_label }}" class="form-label">{{ form.pin_config_version.label }}:</label>
                    {{ form.pin_config_version }}
                    {% if form.pin_config_version.help_text %}<p class="helptext">{{ form.pin_config_version.help_text }}</p>{% endif %}
                    {% if form.pin_config_version.errors %}<ul class="errorlist">{{ form.pin_config_version.errors }}</ul>{% endif %}
                </div>
            </div>

            <h2 class="text-2xl font-semibold text-gray-700 mt-8 mb-4">Plastic Codes</h2>
            <div id="plastic-code-formset-container">
                {{ plastic_formset.management_form }}
                {% for formset_form in plastic_formset %}
                    <div class="inline-formset-row" {% if formset_form.DELETE %}style="display:none;"{% endif %}>
                        {% for hidden in formset_form.hidden_fields %}{{ hidden }}{% endfor %}
                        <div class="form-group">
                            <label for="{{ formset_form.plastic_code_lookup.id_for_label }}" class="form-label">{{ formset_form.plastic_code_lookup.label }}:</label>
                            {{ formset_form.plastic_code_lookup }}
                            {% if formset_form.plastic_code_lookup.help_text %}<p class="helptext">{{ formset_form.plastic_code_lookup.help_text }}</p>{% endif %}
                            {% if formset_form.plastic_code_lookup.errors %}<ul class="errorlist">{{ formset_form.plastic_code_lookup.errors }}</ul>{% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ formset_form.manual_plastic_code.id_for_label }}" class="form-label">{{ formset_form.manual_plastic_code.label }}:</label>
                            {{ formset_form.manual_plastic_code }}
                            {% if formset_form.manual_plastic_code.help_text %}<p class="helptext">{{ formset_form.manual_plastic_code.help_text }}</p>{% endif %}
                            {% if formset_form.manual_plastic_code.errors %}<ul class="errorlist">{{ formset_form.manual_plastic_code.errors }}</ul>{% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ formset_form.quantity.id_for_label }}" class="form-label">{{ formset_form.quantity.label }}:</label>
                            {{ formset_form.quantity }}
                            {% if formset_form.quantity.help_text %}<p class="helptext">{{ formset_form.quantity.help_text }}</p>{% endif %}
                            {% if formset_form.quantity.errors %}<ul class="errorlist">{{ formset_form.quantity.errors }}</ul>{% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ formset_form.thermal_colour.id_for_label }}" class="form-label">{{ formset_form.thermal_colour.label }}:</label>
                            {{ formset_form.thermal_colour }}
                            {% if formset_form.thermal_colour.help_text %}<p class="helptext">{{ formset_form.thermal_colour.help_text }}</p>{% endif %}
                            {% if formset_form.thermal_colour.errors %}<ul class="errorlist">{{ formset_form.thermal_colour.errors }}</ul>{% endif %}
                        </div>
                        {% if formset_form.DELETE %}
                            <input type="checkbox" name="{{ formset_form.DELETE.html_name }}" id="{{ formset_form.DELETE.id_for_label }}" class="hidden">
                        {% else %}
                            <button type="button" class="delete-button" onclick="deleteFormsetRow(this)">Delete</button>
                        {% endif %}
<<<<<<< HEAD
<<<<<<< HEAD
>>>>>>> parent of 63fccc0 (sdsd)
                    </div>
                    {% if pc_form.non_field_errors %}<div class="errorlist mt-1">{% for error in pc_form.non_field_errors %}<li>{{ error }}</li>{% endfor %}</div>{% endif %}
                    <div class="text-right mt-2">
                        <button type="button" class="delete-button" onclick="deleteFormsetRow(this.closest('.plastic-code-row'))">Delete</button>
                    </div>
                </div>
                {% endfor %}
            </div>
<<<<<<< HEAD
            <button type="button" id="add-plastic-code-row" class="add-row-button">Add Plastic Code</button>
        </fieldset>
=======
=======
                    </div>
                {% endfor %}
            </div>
>>>>>>> parent of 63fccc0 (sdsd)
=======
                    </div>
                {% endfor %}
            </div>
>>>>>>> parent of 63fccc0 (sdsd)
            <button type="button" class="add-row-button" onclick="addFormsetRow('plastic-code')">Add Another Plastic Code</button>
>>>>>>> parent of 63fccc0 (sdsd)

        {# ---- Input Files & Workorders (Formset with Nested PANs) ---- #}
        <fieldset class="border border-gray-300 p-4 rounded-md">
            <legend class="text-xl font-semibold text-gray-700 px-2">Input Files & PANs</legend>
            <div id="input-file-formset-container" class="mt-2 space-y-6">
                {{ input_file_formset.management_form }}
                {% for if_form in input_file_formset %}
                <div class="formset-row-container input-file-row" id="{{ input_file_formset.prefix }}-{{ forloop.counter0 }}">
                    {% for hidden in if_form.hidden_fields %}{{ hidden }}{% endfor %}
                    {{ if_form.DELETE }} {# Hidden DELETE checkbox #}
                    <h4 class="text-md font-medium text-gray-600 mb-2">Input File {{ forloop.counter }}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {% for field in if_form.visible_fields %}
                        <div class="form-group">
                            <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}:</label>
                            {{ field }}
                            {% if field.help_text %}<p class="helptext">{{ field.help_text }}</p>{% endif %}
                            {% for error in field.errors %}<div class="errorlist"><li>{{ error }}</li></div>{% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                     {% if if_form.non_field_errors %}<div class="errorlist mt-1">{% for error in if_form.non_field_errors %}<li>{{ error }}</li>{% endfor %}</div>{% endif %}
                    
                    {# Nested PAN Formset #}
                    <div class="nested-formset-container mt-4">
                        <h5 class="text-sm font-medium text-gray-600 mb-2">PANs for this Input File:</h5>
                        {% with pan_formset=pans_formsets|get_item:forloop.counter0 %}
                            <div id="{{ input_file_formset.prefix }}-{{ forloop.parentloop.counter0 }}-pans-container">
                                {{ pan_formset.management_form }}
                                {% for pan_form in pan_formset %}
                                <div class="nested-formset-row pan-row p-3 border border-gray-200 bg-white rounded mb-2" id="{{ pan_formset.prefix }}-{{ forloop.counter0 }}">
                                    {% for hidden in pan_form.hidden_fields %}{{ hidden }}{% endfor %}
                                    {{ pan_form.DELETE }} {# Hidden DELETE checkbox #}
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                        <div class="form-group">
                                            <label for="{{ pan_form.pan_truncated.id_for_label }}" class="form-label">{{ pan_form.pan_truncated.label }}</label>
                                            {{ pan_form.pan_truncated }}
                                            {% for error in pan_form.pan_truncated.errors %}<div class="errorlist"><li>{{ error }}</li></div>{% endfor %}
                                        </div>
                                        <div class="form-group md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                                             <div class="form-group">
                                                <label for="{{ pan_form.plastic_code_lookup.id_for_label }}" class="form-label">{{ pan_form.plastic_code_lookup.label }}</label>
                                                {{ pan_form.plastic_code_lookup }}
                                                {% for error in pan_form.plastic_code_lookup.errors %}<div class="errorlist"><li>{{ error }}</li></div>{% endfor %}
                                            </div>
                                            <div class="form-group">
                                                <label for="{{ pan_form.manual_plastic_code_for_pan.id_for_label }}" class="form-label">{{ pan_form.manual_plastic_code_for_pan.label }}</label>
                                                {{ pan_form.manual_plastic_code_for_pan }}
                                                {% for error in pan_form.manual_plastic_code_for_pan.errors %}<div class="errorlist"><li>{{ error }}</li></div>{% endfor %}
                                            </div>
                                        </div>
                                       
                                    </div>
                                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center mt-1">
                                        <div class="form-group flex items-center">
                                            {{ pan_form.is_available }}
                                            <label for="{{ pan_form.is_available.id_for_label }}" class="form-label !mb-0 ml-2">{{ pan_form.is_available.label }}</label>
                                            {% for error in pan_form.is_available.errors %}<div class="errorlist"><li>{{ error }}</li></div>{% endfor %}
                                        </div>
                                        {% if pan_form.non_field_errors %}<div class="md:col-span-2 errorlist">{% for error in pan_form.non_field_errors %}<li>{{ error }}</li>{% endfor %}</div>{% endif %}
                                    </div>
                                    <div class="text-right mt-2">
                                        <button type="button" class="delete-button delete-pan-row-button" onclick="deleteFormsetRow(this.closest('.pan-row'))">Delete PAN</button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="add-row-button add-pan-row-button mt-2 text-xs py-1 px-2 bg-sky-500 hover:bg-sky-600"
                                    data-prefix="{{ pan_formset.prefix }}"
                                    data-container-selector="#{{ input_file_formset.prefix }}-{{ forloop.parentloop.counter0 }}-pans-container"
                                    data-template-selector="#empty-pan-form-template">
                                Add PAN to this File
                            </button>
                        {% endwith %}
                    </div>
                    <div class="text-right mt-3">
                        <button type="button" class="delete-button delete-input-file-row-button" onclick="deleteFormsetRow(this.closest('.input-file-row'))">Delete Input File</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            <button type="button" id="add-input-file-row" class="add-row-button">Add Input File</button>
        </fieldset>

        {# ---- Shipping Details (Single Form) ---- #}
        <fieldset class="border border-gray-300 p-4 rounded-md">
            <legend class="text-xl font-semibold text-gray-700 px-2">Shipping Details</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-2">
                {% for field in shipping_form %}
                <div class="form-group">
                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}:</label>
                    {{ field }}
                    {% if field.help_text %}<p class="helptext">{{ field.help_text }}</p>{% endif %}
                    {% for error in field.errors %}<div class="errorlist"><li>{{ error }}</li></div>{% endfor %}
                </div>
                {% endfor %}
            </div>
             {% if shipping_form.non_field_errors %}<div class="errorlist mt-1">{% for error in shipping_form.non_field_errors %}<li>{{ error }}</li>{% endfor %}</div>{% endif %}
        </fieldset>

        {# ---- Action Buttons ---- #}
        <div class="mt-8 flex justify-end gap-4">
            <button type="submit" name="action" value="save_draft" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300">
                Save Draft
            </button>
            <button type="submit" name="action" value="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300">
                Submit TVF to NPI
            </button>
        </div>
    </form>

    <div class="mt-8 text-center">
        <a href="{% url 'test_requests:coach_dashboard' %}" class="text-indigo-600 hover:text-indigo-800">Back to Dashboard</a>
    </div>
</div>

{# ---- Empty Form Templates for JavaScript ---- #}
<div style="display: none;">
    <template id="empty-plastic-code-form-template">
        <div class="formset-row-container plastic-code-row" id="{{ plastic_formset.prefix }}-__prefix__">
            {% for hidden in plastic_formset.empty_form.hidden_fields %}{{ hidden }}{% endfor %}
            {{ plastic_formset.empty_form.DELETE }}
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div class="form-group md:col-span-2">
                    <label for="{{ plastic_formset.empty_form.plastic_code_lookup.id_for_label }}" class="form-label">{{ plastic_formset.empty_form.plastic_code_lookup.label }}</label>
                    {{ plastic_formset.empty_form.plastic_code_lookup }}
                </div>
                <div class="form-group">
                    <label for="{{ plastic_formset.empty_form.manual_plastic_code.id_for_label }}" class="form-label">{{ plastic_formset.empty_form.manual_plastic_code.label }}</label>
                    {{ plastic_formset.empty_form.manual_plastic_code }}
                </div>
                <div class="form-group">
                    <label for="{{ plastic_formset.empty_form.quantity.id_for_label }}" class="form-label">{{ plastic_formset.empty_form.quantity.label }}</label>
                    {{ plastic_formset.empty_form.quantity }}
                </div>
            </div>
            <div class="text-right mt-2">
                <button type="button" class="delete-button" onclick="deleteFormsetRow(this.closest('.plastic-code-row'))">Delete</button>
            </div>
        </div>
    </template>

    <template id="empty-input-file-form-template">
        <div class="formset-row-container input-file-row" id="{{ input_file_formset.prefix }}-__prefix__">
            {% for hidden in input_file_formset.empty_form.hidden_fields %}{{ hidden }}{% endfor %}
            {{ input_file_formset.empty_form.DELETE }}
            <h4 class="text-md font-medium text-gray-600 mb-2">Input File <span class="new-form-count"></span></h4>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for field in input_file_formset.empty_form.visible_fields %}
                <div class="form-group">
                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}:</label>
                    {{ field }}
                </div>
                {% endfor %}
            </div>
            <div class="nested-formset-container mt-4">
                <h5 class="text-sm font-medium text-gray-600 mb-2">PANs for this Input File:</h5>
                <div id="{{ input_file_formset.prefix }}-__prefix__-pans-container">
                    {# Management form for PANs will be dynamically inserted by JS if needed for new input files #}
                    {# or use the one from pans_formsets.0.empty_form if that's how it's structured #}
                    <input type="hidden" name="{{ input_file_formset.prefix }}-__prefix__-pans-TOTAL_FORMS" value="0" id="id_{{ input_file_formset.prefix }}-__prefix__-pans-TOTAL_FORMS" />
                    <input type="hidden" name="{{ input_file_formset.prefix }}-__prefix__-pans-INITIAL_FORMS" value="0" id="id_{{ input_file_formset.prefix }}-__prefix__-pans-INITIAL_FORMS" />
                    <input type="hidden" name="{{ input_file_formset.prefix }}-__prefix__-pans-MIN_NUM_FORMS" value="0" id="id_{{ input_file_formset.prefix }}-__prefix__-pans-MIN_NUM_FORMS" />
                    <input type="hidden" name="{{ input_file_formset.prefix }}-__prefix__-pans-MAX_NUM_FORMS" value="1000" id="id_{{ input_file_formset.prefix }}-__prefix__-pans-MAX_NUM_FORMS" />
                </div>
                <button type="button" class="add-row-button add-pan-row-button mt-2 text-xs py-1 px-2 bg-sky-500 hover:bg-sky-600"
                        data-prefix="{{ input_file_formset.prefix }}-__prefix__-pans" 
                        data-container-selector="#{{ input_file_formset.prefix }}-__prefix__-pans-container"
                        data-template-selector="#empty-pan-form-template">
                    Add PAN to this File
                </button>
            </div>
            <div class="text-right mt-3">
                <button type="button" class="delete-button delete-input-file-row-button" onclick="deleteFormsetRow(this.closest('.input-file-row'))">Delete Input File</button>
            </div>
        </div>
    </template>

    <template id="empty-pan-form-template">
        {# Assuming pans_formsets.0 is available in context for empty_form structure #}
        {% with empty_pan_form=pans_formsets.0.empty_form %}
        <div class="nested-formset-row pan-row p-3 border border-gray-200 bg-white rounded mb-2" id="{{ empty_pan_form.prefix|slice:":-10" }}__pan_prefix__">
            {% for hidden in empty_pan_form.hidden_fields %}{{ hidden }}{% endfor %}
            {{ empty_pan_form.DELETE }}
             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div class="form-group">
                    <label for="{{ empty_pan_form.pan_truncated.id_for_label }}" class="form-label">{{ empty_pan_form.pan_truncated.label }}</label>
                    {{ empty_pan_form.pan_truncated }}
                </div>
                <div class="form-group md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                     <div class="form-group">
                        <label for="{{ empty_pan_form.plastic_code_lookup.id_for_label }}" class="form-label">{{ empty_pan_form.plastic_code_lookup.label }}</label>
                        {{ empty_pan_form.plastic_code_lookup }}
                    </div>
                    <div class="form-group">
                        <label for="{{ empty_pan_form.manual_plastic_code_for_pan.id_for_label }}" class="form-label">{{ empty_pan_form.manual_plastic_code_for_pan.label }}</label>
                        {{ empty_pan_form.manual_plastic_code_for_pan }}
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center mt-1">
                <div class="form-group flex items-center">
                    {{ empty_pan_form.is_available }}
                    <label for="{{ empty_pan_form.is_available.id_for_label }}" class="form-label !mb-0 ml-2">{{ empty_pan_form.is_available.label }}</label>
                </div>
            </div>
            <div class="text-right mt-2">
                <button type="button" class="delete-button delete-pan-row-button" onclick="deleteFormsetRow(this.closest('.pan-row'))">Delete PAN</button>
            </div>
        </div>
        {% endwith %}
    </template>
</div>

{% endblock %}


{% block extra_js %}
{{ block.super }} {# Includes base.html's extra_js if any #}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    const customerSelect = $('#id_customer');
    const environmentSelect = $('#id_tvf_environment');
    const projectSelect = $('#id_project');
    const trustportFolderSelect = $('#id_trustport_folder_actual');
    const shippingDispatchMethodSelect = $('#id_shipping_details-dispatch_method'); // Corrected ID if prefix is 'shipping_details'
                                                                              // Or ensure your shipping_form prefix in view matches.
                                                                              // Based on your forms.py, shipping_form is top-level
                                                                              // so likely: $('#id_dispatch_method') if shipping_form not prefixed,
                                                                              // or $('#id_shipping-dispatch_method') if prefix='shipping' was used for it.
                                                                              // Assuming prefix 'shipping' from view for TestRequestShippingForm

    const plasticCodeFormsetContainer = $('#plastic-code-formset-container');
    const inputFileFormsetContainer = $('#input-file-formset-container');

    function getPanPlasticCodeSelects() {
        return $('select.pan-plastic-code-lookup'); // Class added to PAN plastic code select in forms.py
    }

    function updateProjectOptions() {
        const customerId = customerSelect.val();
        const environmentId = environmentSelect.val();
        const currentProjectVal = projectSelect.val(); // Preserve current value

        projectSelect.empty().append($('<option value=""></option>').text('Loading...'));
        
        if (customerId && environmentId) {
            $.ajax({
                url: '{% url "test_requests:get_filtered_projects" %}',
                data: { 'customer_id': customerId, 'environment_id': environmentId },
                success: function(data) {
                    projectSelect.empty().append($('<option value=""></option>').text('Select Project'));
                    $.each(data.projects, function(key, value) {
                        projectSelect.append($('<option></option>').attr('value', value.id).text(value.name));
                    });
                    if (data.projects.some(p => p.id == currentProjectVal)) {
                        projectSelect.val(currentProjectVal);
                    } else {
                         projectSelect.val("{{ form.project.value|default:''|escapejs }}"); // Try to restore from initial form data
                    }
                    projectSelect.trigger('change'); // Update dependents
                },
                error: function() {
                    projectSelect.empty().append($('<option value=""></option>').text('Error loading projects'));
                    projectSelect.trigger('change');
                }
            });
        } else {
            projectSelect.empty().append($('<option value=""></option>').text('Select Customer & Environment first'));
            projectSelect.trigger('change'); // Clear dependents
        }
    }

    function updateDependentOnProjectOptions() {
        const customerId = customerSelect.val();
        const projectId = projectSelect.val();
        const environmentId = environmentSelect.val();

        // Update Trustport Folders
        const currentTrustportVal = trustportFolderSelect.val();
        trustportFolderSelect.empty().append($('<option value=""></option>').text('Loading...'));
        if (customerId && projectId) {
            $.ajax({
                url: '{% url "test_requests:get_filtered_trustport_folders" %}',
                data: { 'customer_id': customerId, 'project_id': projectId },
                success: function(data) {
                    trustportFolderSelect.empty().append($('<option value=""></option>').text('Select Trustport Folder'));
                    $.each(data.folders, function(key, value) {
                        trustportFolderSelect.append($('<option></option>').attr('value', value.id).text(value.folder_path));
                    });
                     if (data.folders.some(f => f.id == currentTrustportVal)) {
                        trustportFolderSelect.val(currentTrustportVal);
                    } else {
                        trustportFolderSelect.val("{{ form.trustport_folder_actual.value|default:''|escapejs }}");
                    }
                },
                error: function() {
                    trustportFolderSelect.empty().append($('<option value=""></option>').text('Error loading folders'));
                }
            });
        } else {
            trustportFolderSelect.empty().append($('<option value=""></option>').text('Select Project first'));
        }

        // Update Shipping Dispatch Methods
        const currentDispatchVal = shippingDispatchMethodSelect.val();
        shippingDispatchMethodSelect.empty().append($('<option value=""></option>').text('Loading...'));
        if (customerId && projectId) {
             $.ajax({
                url: '{% url "test_requests:get_filtered_dispatch_methods" %}',
                data: { 'customer_id': customerId, 'project_id': projectId },
                success: function(data) {
                    shippingDispatchMethodSelect.empty().append($('<option value=""></option>').text('Select Dispatch Method'));
                    $.each(data.methods, function(key, value) {
                        shippingDispatchMethodSelect.append($('<option></option>').attr('value', value.id).text(value.name));
                    });
                    if (data.methods.some(m => m.id == currentDispatchVal)) {
                        shippingDispatchMethodSelect.val(currentDispatchVal);
                    } else {
                        // Assuming shipping_form is passed to template directly, not as part of 'form'
                        shippingDispatchMethodSelect.val("{{ shipping_form.dispatch_method.value|default:''|escapejs }}");
                    }
                },
                error: function() {
                     shippingDispatchMethodSelect.empty().append($('<option value=""></option>').text('Error loading methods'));
                }
            });
        } else {
            shippingDispatchMethodSelect.empty().append($('<option value=""></option>').text('Select Project first'));
        }
        updateAllPlasticCodeDropdowns(customerId, projectId, environmentId);
    }

    function updateAllPlasticCodeDropdowns(customerId, projectId, environmentId) {
        const mainFormPlasticCodeSelects = plasticCodeFormsetContainer.find('select[id$="-plastic_code_lookup"]');
        const panFormPlasticCodeSelects = getPanPlasticCodeSelects(); // Selects PAN plastic code dropdowns
        const allPlasticCodeSelects = mainFormPlasticCodeSelects.add(panFormPlasticCodeSelects);

        allPlasticCodeSelects.each(function() {
            const currentSelect = $(this);
            const selectedValue = currentSelect.val(); // Preserve current selection
            currentSelect.empty().append($('<option value=""></option>').text('Loading...'));

<<<<<<< HEAD
            if (customerId && projectId && environmentId) {
                $.ajax({
                    url: '{% url "test_requests:get_filtered_plastic_codes" %}',
                    data: {
                        'customer_id': customerId,
                        'project_id': projectId,
                        'environment_id': environmentId
                    },
                    success: function(data) {
                        currentSelect.empty().append($('<option value=""></option>').text('Select Plastic Code'));
                        $.each(data.plastic_codes, function(key, value) {
                            currentSelect.append($('<option></option>').attr('value', value.id).text(value.code));
                        });
                        if (data.plastic_codes.some(pc => pc.id == selectedValue)) {
                            currentSelect.val(selectedValue);
                        }
                    },
                    error: function() {
                        currentSelect.empty().append($('<option value=""></option>').text('Error loading codes'));
                    }
                });
            } else {
                currentSelect.empty().append($('<option value=""></option>').text('Select C/P/E first'));
=======
            container.appendChild(newRow);
            totalFormsInput.value = currentForms + 1;

            const deleteButton = newRow.querySelector('.delete-button');
            if (deleteButton) {
                deleteButton.onclick = function() { deleteNestedFormsetRow(this); };
            }
        }

        function deleteNestedFormsetRow(button) {
            const row = button.closest('.nested-formset-row');
            const deleteCheckbox = row.querySelector('input[type="checkbox"][id$="-DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                row.style.display = 'none';
            } else {
                row.remove();
            }
        }
    </script>

    {# Empty form templates for JavaScript to clone #}
    <div style="display: none;">
        {# Plastic Code Empty Form #}
        <div id="empty-plastic-code-form">
            <div class="inline-formset-row">
                {% for field in plastic_formset.empty_form %}
                    <div class="form-group">
                        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}:</label>
                        {{ field }}
                        {% if field.help_text %}<p class="helptext">{{ field.help_text }}</p>{% endif %}
                        {% if field.errors %}<ul class="errorlist">{{ field.errors }}</ul>{% endif %}
                    </div>
                {% endfor %}
                <button type="button" class="delete-button" onclick="deleteFormsetRow(this)">Delete</button>
            </div>
        </div>

        {# Input File Empty Form #}
        <div id="empty-input-file-form">
            <div class="inline-formset-row">
                {% for field in input_file_formset.empty_form %}
                    <div class="form-group">
                        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}:</label>
                        {{ field }}
                        {% if field.help_text %}<p class="helptext">{{ field.help_text }}</p>{% endif %}
                        {% if field.errors %}<ul class="errorlist">{{ field.errors }}</ul>{% endif %}
                    </div>
                {% endfor %}
                <button type="button" class="delete-button" onclick="deleteFormsetRow(this)">Delete Input File</button>

                {# Nested PAN Formset for an empty Input File #}
                <div class="nested-formset-container w-full">
                    <h3 class="text-xl font-semibold text-gray-600 mb-3">PANs for New File</h3>
                    {# This needs a dynamically named management form #}
                    {# The actual management form for the empty form will be rendered by pan_formset.management_form when it's initially created for the first input_file_form #}
                    {# For newly added input_file_forms by JS, we need to manually insert its management form with the correct prefix #}
                    <input type="hidden" name="input_files-__prefix__-pans-TOTAL_FORMS" id="id_input_files-__prefix__-pans-TOTAL_FORMS" value="0">
                    <input type="hidden" name="input_files-__prefix__-pans-INITIAL_FORMS" id="id_input_files-__prefix__-pans-INITIAL_FORMS" value="0">
                    <input type="hidden" name="input_files-__prefix__-pans-MIN_NUM_FORMS" id="id_input_files-__prefix__-pans-MIN_NUM_FORMS" value="0">
                    <input type="hidden" name="input_files-__prefix__-pans-MAX_NUM_FORMS" id="id_input_files-__prefix__-pans-MAX_NUM_FORMS" value="1000">
                    
                    {# The button for adding new PANs inside this new input file #}
                    <button type="button" class="add-row-button bg-blue-500 hover:bg-blue-600" 
                        onclick="addNestedFormsetRow(this, 'input_files-__prefix__-pans')">Add Another PAN</button>
                </div>
            </div>
        </div>

        {# PAN Empty Form (for nested formset) #}
        <div id="empty-pan-form">
            <div class="nested-formset-row">
                {% for field in pans_formsets.0.empty_form %} {# Use .0 to get the first formset's empty_form #}
                    <div class="form-group">
                        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}:</label>
                        {{ field }}
                        {% if field.help_text %}<p class="helptext">{{ field.help_text }}</p>{% endif %}
                        {% if field.errors %}<ul class="errorlist">{{ field.errors }}</ul>{% endif %}
                    </div>
                {% endfor %}
                <button type="button" class="delete-button" onclick="deleteNestedFormsetRow(this)">Delete PAN</button>
            </div>
        </div>
    </div>

    {# JavaScript for Dynamic Dropdowns #}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            const customerSelect = $('#id_customer');
            const environmentSelect = $('#id_tvf_environment');
            const projectSelect = $('#id_project');
            const trustportFolderSelect = $('#id_trustport_folder_actual');
            const dispatchMethodSelect = $('#id_shipping-dispatch_method');
            const plasticCodeLookupContainer = $('#plastic-code-formset-container');

            function updateProjectOptions() {
                const customerId = customerSelect.val();
                const environmentId = environmentSelect.val();
                
                if (customerId && environmentId) {
                    $.ajax({
                        url: '{% url "test_requests:get_filtered_projects" %}',
                        data: { 
                            'customer_id': customerId,
                            'environment_id': environmentId 
                        },
                        success: function(data) {
                            projectSelect.empty();
                            projectSelect.append($('<option></option>').attr('value', '').text('Select Project'));
                            $.each(data.projects, function(key, value) {
                                projectSelect.append($('<option></option>').attr('value', value.id).text(value.name));
                            });
                            // Trigger update for other dependent fields if project is already selected
                            if (projectSelect.val()) {
                                updateDependentOptions();
                            } else {
                                trustportFolderSelect.empty().append($('<option></option>').attr('value', '').text('Select Trustport Folder'));
                                dispatchMethodSelect.empty().append($('<option></option>').attr('value', '').text('Select Dispatch Method'));
                                updateAllPlasticCodeOptions();
                            }
                        }
                    });
                } else {
                    projectSelect.empty().append($('<option></option>').attr('value', '').text('Select Project'));
                    trustportFolderSelect.empty().append($('<option></option>').attr('value', '').text('Select Trustport Folder'));
                    dispatchMethodSelect.empty().append($('<option></option>').attr('value', '').text('Select Dispatch Method'));
                    updateAllPlasticCodeOptions();
                }
            }

            function updateDependentOptions() {
                const customerId = customerSelect.val();
                const projectId = projectSelect.val();

                if (customerId && projectId) {
                    // Update Trustport Folders
                    $.ajax({
                        url: '{% url "test_requests:get_filtered_trustport_folders" %}',
                        data: { 'customer_id': customerId, 'project_id': projectId },
                        success: function(data) {
                            trustportFolderSelect.empty();
                            trustportFolderSelect.append($('<option></option>').attr('value', '').text('Select Trustport Folder'));
                            $.each(data.folders, function(key, value) {
                                trustportFolderSelect.append($('<option></option>').attr('value', value.id).text(value.folder_path));
                            });
                        }
                    });

                    // Update Dispatch Methods
                    $.ajax({
                        url: '{% url "test_requests:get_filtered_dispatch_methods" %}',
                        data: { 'customer_id': customerId, 'project_id': projectId },
                        success: function(data) {
                            dispatchMethodSelect.empty();
                            dispatchMethodSelect.append($('<option></option>').attr('value', '').text('Select Dispatch Method'));
                            $.each(data.methods, function(key, value) {
                                dispatchMethodSelect.append($('<option></option>').attr('value', value.id).text(value.name));
                            });
                        }
                    });

                    // Update Plastic Codes for all formset rows
                    updateAllPlasticCodeOptions();

                } else {
                    trustportFolderSelect.empty().append($('<option></option>').attr('value', '').text('Select Trustport Folder'));
                    dispatchMethodSelect.empty().append($('<option></option>').attr('value', '').text('Select Dispatch Method'));
                    updateAllPlasticCodeOptions();
                }
            }

            function updateAllPlasticCodeOptions() {
                const customerId = customerSelect.val();
                const projectId = projectSelect.val();
                
                // Select all plastic code dropdowns currently in the DOM
                const plasticCodeLookupSelects = plasticCodeLookupContainer.find('select[id$="-plastic_code_lookup"]');

                plasticCodeLookupSelects.each(function() {
                    const currentPlasticCodeSelect = $(this);
                    currentPlasticCodeSelect.empty().append($('<option></option>').attr('value', '').text('Select Plastic Code (if in lookup)'));

                    if (customerId && projectId) {
                        $.ajax({
                            url: '{% url "test_requests:get_filtered_plastic_codes" %}',
                            data: { 'customer_id': customerId, 'project_id': projectId },
                            success: function(data) {
                                $.each(data.plastic_codes, function(key, value) {
                                    currentPlasticCodeSelect.append($('<option></option>').attr('value', value.id).text(value.code));
                                });
                            }
                        });
                    }
                });
            }

            // Event listeners
            customerSelect.change(updateProjectOptions);
            environmentSelect.change(updateProjectOptions);
            projectSelect.change(updateDependentOptions);

            // Initial load
            if (customerSelect.val() && environmentSelect.val()) {
                updateProjectOptions();
            } else {
                projectSelect.empty().append($('<option></option>').attr('value', '').text('Select Project'));
                trustportFolderSelect.empty().append($('<option></option>').attr('value', '').text('Select Trustport Folder'));
                dispatchMethodSelect.empty().append($('<option></option>').attr('value', '').text('Select Dispatch Method'));
                updateAllPlasticCodeOptions();
            }
        });

        // Function to calculate Request Ship Date based on SLA
        $(document).ready(function() {
            const requestReceivedDateInput = $('#id_request_received_date');
            const requestShipDateInput = $('#id_request_ship_date');
            const customerSelect = $('#id_customer');

            function calculateShipDate() {
                const receivedDateStr = requestReceivedDateInput.val();
                const customerId = customerSelect.val();

                if (receivedDateStr && customerId) {
                    $.ajax({
                        url: '{% url "test_requests:get_sla_and_calculate_ship_date" %}',
                        data: {
                            'received_date': receivedDateStr,
                            'customer_id': customerId
                        },
                        success: function(data) {
                            if (data.ship_date) {
                                requestShipDateInput.val(data.ship_date);
                            } else {
                                requestShipDateInput.val('');
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error("Error calculating ship date:", error);
                            requestShipDateInput.val('');
                        }
                    });
                } else {
                    requestShipDateInput.val('');
                }
            }

            requestReceivedDateInput.on('change', calculateShipDate);
            customerSelect.on('change', calculateShipDate);

            if (requestReceivedDateInput.val() && customerSelect.val()) {
                calculateShipDate();
            } else if (requestReceivedDateInput.val()) {
                 requestShipDateInput.val('');
>>>>>>> parent of 63fccc0 (sdsd)
            }
        });
    }
    
    // Calculate Ship Date
    const requestReceivedDateInput = $('#id_request_received_date');
    const requestShipDateInput = $('#id_request_ship_date');
    function calculateShipDate() {
        const receivedDateStr = requestReceivedDateInput.val();
        const customerId = customerSelect.val();
        if (receivedDateStr && customerId) {
            $.ajax({
                url: '{% url "test_requests:get_sla_and_calculate_ship_date" %}',
                data: { 'received_date': receivedDateStr, 'customer_id': customerId },
                success: function(data) {
                    requestShipDateInput.val(data.ship_date || '');
                },
                error: function() { requestShipDateInput.val(''); }
            });
        } else {
            requestShipDateInput.val('');
        }
    }
    requestReceivedDateInput.on('change input', calculateShipDate);
    customerSelect.on('change', calculateShipDate); // Also recalc if customer changes

    // Initial population
    if (customerSelect.val() && environmentSelect.val()) {
        updateProjectOptions(); // This will trigger dependent updates via .trigger('change')
    } else {
        updateDependentOnProjectOptions(); // Clear/initialize dependents
    }
    calculateShipDate(); // Initial SLA calculation


    // --- Formset Add/Delete Functions ---
    function deleteFormsetRow(rowElement) {
        const deleteCheckbox = $(rowElement).find('input[type="checkbox"][name$="-DELETE"]');
        if (deleteCheckbox.length > 0) {
            deleteCheckbox.prop('checked', true);
            $(rowElement).hide();
        } else {
            // For rows not yet saved (no instance.pk, so no server-side DELETE field initially rendered by Django)
            $(rowElement).remove();
        }
        // Update management form if necessary, or just rely on Django processing hidden DELETE
    }
    window.deleteFormsetRow = deleteFormsetRow; // Make it globally accessible for onclick

    function addFormsetRow(buttonElement, prefix, containerSelector, templateSelector) {
        const container = $(containerSelector);
        const totalFormsInput = $(`#id_${prefix}-TOTAL_FORMS`);
        let currentForms = parseInt(totalFormsInput.val());

        const templateHtml = $(templateSelector).html();
        const newRowHtml = templateHtml.replace(/__prefix__/g, currentForms);
        
        const newRow = $(newRowHtml);
        container.append(newRow);
        totalFormsInput.val(currentForms + 1);

        // For new plastic code rows, populate their dropdown
        if (prefix === '{{ plastic_formset.prefix }}') {
            const newPcSelect = newRow.find('select[id$="-plastic_code_lookup"]');
            updateAllPlasticCodeDropdowns(customerSelect.val(), projectSelect.val(), environmentSelect.val()); // Re-update all, or just the new one
        }
        // For new input file rows, initialize its nested PAN formset add button
        if (prefix === '{{ input_file_formset.prefix }}') {
            newRow.find('.new-form-count').text(currentForms + 1); // Update visual counter
            const panContainer = newRow.find('[id$="-pans-container"]');
            const panPrefix = `${prefix}-${currentForms}-pans`;
            panContainer.attr('id', `id_${panPrefix}-container`); // Correct container ID for nested

            // Update nested management forms
            panContainer.find('input[name$="-TOTAL_FORMS"]').attr('name', `${panPrefix}-TOTAL_FORMS`).attr('id', `id_${panPrefix}-TOTAL_FORMS`).val(0);
            panContainer.find('input[name$="-INITIAL_FORMS"]').attr('name', `${panPrefix}-INITIAL_FORMS`).attr('id', `id_${panPrefix}-INITIAL_FORMS`).val(0);
            // etc. for MIN_NUM, MAX_NUM

            const addPanButton = newRow.find('.add-pan-row-button');
            addPanButton.attr('data-prefix', panPrefix);
            addPanButton.attr('data-container-selector', `#id_${panPrefix}-container`);
        }
    }
    window.addFormsetRow = addFormsetRow;


    $('#add-plastic-code-row').click(function() {
        addFormsetRow(this, '{{ plastic_formset.prefix }}', '#plastic-code-formset-container', '#empty-plastic-code-form-template');
    });
    $('#add-input-file-row').click(function() {
        addFormsetRow(this, '{{ input_file_formset.prefix }}', '#input-file-formset-container', '#empty-input-file-form-template');
    });

    // Delegated event for adding PAN rows
    $(document).on('click', '.add-pan-row-button', function() {
        const button = $(this);
        const prefix = button.data('prefix');
        const containerSelector = button.data('container-selector');
        const templateSelector = button.data('template-selector');
        
        const container = $(containerSelector);
        const totalFormsInput = container.find(`input[name="${prefix}-TOTAL_FORMS"]`);
        if (!totalFormsInput.length) {
            console.error("PAN Management form not found for prefix:", prefix);
            return;
        }
        let currentForms = parseInt(totalFormsInput.val());

        const templateHtml = $(templateSelector).html();
        // The template for PAN uses __pan_prefix__, not the main formset's __prefix__
        const newRowHtml = templateHtml.replace(/__pan_prefix__/g, currentForms)
                                       .replace(new RegExp( $(templateSelector).find('input:first').attr('name').split('-')[0] + '-\\d+', 'g'), prefix + '-' + currentForms);


        const newRow = $(newRowHtml);
        // Set the ID of the new row to be unique
        newRow.attr('id', `${prefix}-${currentForms}`);

        container.append(newRow);
        totalFormsInput.val(currentForms + 1);
        
        // Populate plastic code lookup in the newly added PAN row
        const newPanPcSelect = newRow.find('select.pan-plastic-code-lookup');
        if (newPanPcSelect.length > 0) {
             updateAllPlasticCodeDropdowns(customerSelect.val(), projectSelect.val(), environmentSelect.val());
        }
    });

});
</script>
{% endblock %}